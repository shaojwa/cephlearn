## 目录
- [什么是纠删码](#什么是纠删码)
- [为什么需要EC](#为什么需要纠删码)

----
## 什么是纠删码
纠删码，Erasure Code，erasure是一个名词，含义是移除，删除。那Erasure Code是什么意思？ 这是起源于通信系统的概念。
通过原始数据进行编码生成备份数据，来保证部分原始数据或者备份数据的丢失都能得到修复。这里注意一点，是丢失，篡改。
也就是说，其中部分数据被修改，我们无法知道是哪部分数据被修改。

## 为什么需要EC
为了降低存储空间成本，我们不能再任何场景下都使用多副本策略。

## 传统存储中的RAID
数据存在单一磁盘上时，有几个问题，首先是，读写速度相对慢，因为无法实现并发。
其次是数据安全性低，有磁盘损坏，数据丢失无法恢复。最后一个就是，容量有限，尽管现在单盘容量越来越大，还是无法满足需求。
所以很自然，就会想到用多个磁盘组合来提供服务，RAID就是在这方面的探索尝试。

## RAID中的条带
单盘有扇区，这是单盘访问的最小单元。RAID也虚拟出一个概念，条带。这是RAID的最小访问单元。这是一种虚拟化的设计方法，而不是再次把磁盘格式化为条带。
而是想办法把把多个磁盘虚拟成一个磁盘进行统一管理，条带就是要建立虚拟盘和物理上多个盘之间的数据映射关系。

虚拟盘的统一的线性的。

### 条带的宽度
条带stripe，是RAID最小的访问单元，它是跨磁盘的，那么一般来说，一个条带跨多少个磁盘呢？是否为RAID中磁盘的数目呢？

### 条带的深度
就是条带在单块磁盘上的数据大小，一般是磁盘基本块的整数倍，比如是扇区的整数倍。

### RAID0
完全不具备容错能力

### RAID1
每个磁盘写入的数据完全相同，此时也叫镜像。

### RAID5
生成一个校验块，注意生成校验块的算法是异或，RAID5能提供的IO能力是所有磁盘和的(N-1)/N，其中N为条带宽度。一般来说，条带深度是一个或多个基本块。如果有磁盘损坏，可以通过异或运算恢复。

一个有意思的现象是，因为校验块通常不需要读取，所以一般来说，如果校验块都在一个磁盘上，那么那个磁盘的带块基本是浪费的，因为不出错的情况下不会去读取校验块。
问题是真的很少读取校验块么？我不太清楚。如果真这样，为了不浪费读带块，通常校验块的位置是跳动的，也就是说会分配到不通的磁盘上。这如何实现呢？可以考虑下。

还有一个有意思的现象是，一般的设计中RAID5的条带宽度和深度都是固定的，但是也有不固定的，比如ZFS中的RAID5技术，也被称为RAIDZ，条带宽度和深度会随着前段下发的IO动态调整大小。为什么这么做？避免空间浪费和提高IO并发能力。

### 小IO场景
如果strip的宽度是5，深度是4K，很显然最合适的写入大小是16K，如果写入只有4K，怎么办。那么这4K只能在其中的一个磁盘上，其他RAID块只能填零，这就会浪费IO可磁盘空间。所以ZFS会动态调整条带的宽度和深度。

### RAID组合
### 高阶RAID的数学原理
理论上，校验计算的方法有很多，比如累加求和也是一种办法，但是这种方法有几个问题，这也是校验算法常常要考虑的原因:（1）校验数据是否和原数据使用相同的空间（2）校验算法是否存在逆运算。(3)块生成算法是否足够高效。

原理上来说，如果有n个数据块，如何生成m个校验块，这m个校验块就是需要求解的未知数，求解m个未知数，理论上需要m个方程。 多元未知数的求解方程可以用矩阵来表示。

### RS RAID
RS是两个科学家，最早研究用于解决通信领域纠正信息传输过程中的静默错误的Reed-Solomon codes。

** FD = C ***
其中F是范德蒙德矩阵，加上单位矩阵形成的生成矩阵A，A中的任意n行都是线性独立，所以可以通过高斯消元法求解出。

## EC的实现方式
纠删码的最简单使用场景，复制一份，就是镜像。显然存储空间成本太高，所以也发展出其他的副本策略，比如 RAID5，RAID6，以及更一般的RS-RAID。 RAID一般翻译成**独立冗余磁盘阵列**，不过我倾向于翻译成**独立磁盘冗余阵列**。

#### 实际场景
因为备份数据越多，通常生成算法越复杂，同时很自然的，需要的存储空间也越大。出于对编解码效率的考虑，生产环境中很少使用**阶数**（备份数据份数） 大于2的纠删码。

## EC标准库
## EC的高级特性
#### ovverwrite 覆盖写

## EC的数学原理
