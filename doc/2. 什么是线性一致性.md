https://zhuanlan.zhihu.com/p/42239873

#### CAP中的C

1. C就是一致性，CAP中的C是强一致性，也叫线性一致性，或者叫原子一致性。那什么是线性一致性？
1. 就足球比赛，在多个副本上查询结果都一样，才叫强一致性，如果某一时刻A查到结果和B查到结果不一样，那就不是线性一致。
1. 如果是只有一个副本，没有这个问题，更新操作是原子的，如果不只有一个副本，那就不一样，多个副本之前的更新存在延时。
1. 所以，**一致性其实主要是描述了在故障和延迟的情况下副本间的状态协调的问题**

#### 线性一致性的目标

1. 让一个多副本的系统看起来只有一个副本，而且所有的操作都是原子性的。 
1. 也就是说，一个操作尽管需要一段时间，但是真的发生改变的操作必须是原子性的在某一个时间点发生。  
1. 这个点之后，所有客户端的读取都是新值，这个点之前，读取到的都是旧值。  

#### 最关键的点

1.write也好，read也好，整个调用时需要一段时间的，但是要谈到一致性，就必须对所有的这些操作的时间段内找到一个瞬间的点，以此排序。
1， 所有的先后按照这个时间点来决定，早的时间点看到的结果，必须在后续的时间点上也能看到。

#### 和事务一致性的区别

1. 线性一致性是保证单个操作的原子和瞬间，瞬间是为了让某个操作的变化 有个明确的时间点。
2. 事务一致性是一组操作的原子性。
1. 线性一致性不只是在分布式系统中，还存在于本地系统，比如多个CPU架构下，普通变量就不是线性一致性，只有atomic才是线性一致性。
1. 别的一些数据结构，比如mutex，也要求需要必须满足线性一致性。

##### 如何实现线性一致性系统
 通过之前，我们了解到，多个副本的更新的要一致，怎么一致呢？某个节点更新之后，所有后续的查询，不管在哪个节点上，都是更新的数据，很难呀！
 
1. 通过leader来write，加上日志，保证leader节点写的一致性，然后leader负责和其他副本的同步
1. read也是要发到leader上去读的 不是所有副本上都随机读的。

#### 线性一致性的应用

1. 实现分布式锁，分布式锁必须要求是线性一致性的。分布式锁也是实现其他功能的前提条件，比如实现leader的选举就需要用到分布式锁。
1. 存储系统中的块存储数据，这要求有线性一致性，不然基于快存储的数据库系统就不好做。

#### 线性一致性的代价

1. 性能的下降，比如mutex来同步，atomic变量等，不可避免得降低性能。
1. 很多场景不需要线性一致性，是需要有比较弱的一致性，比如单调读，这样就不需要每次都从leader上去读，只要保证每个客户端读取的都是同一个副本。

#### 再谈谈CAP中的P

CAP，P网络分区是一种错误，不是一个选项，一定会发生。那什么是网络分区？可以这么理解，一个集群中，所有的节点本来应该是全部联通的。
但是因为网络故障，集群中的节点有的不通，这个时候还要保证数据可用，那就必须要有多副本，而且尽量分散到不通的区里，这样一个区挂掉，还有别的区。
但是有了多个副本，数据一致性就成为一个问题。

#### 进一步学习

线性一致性系统确实比较慢，这是一个事实，所以提高性能是如此的重要，Raft 性能优化，batch，pipeline，async commit & apply 各种提高性能的手段一起上，paxos 性能优化，paxos 变种 multi-paxos等等都是在为提高性能作出努力
