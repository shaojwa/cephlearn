# Snap 原理

## 快照基本原理

新数据N，原有数据P，打快照时有两种选择：

（1）马上把原有数据拷贝出去，这样原有对象就可以写新的数据。但是这样的话，快照操作耗时很多，因为需要原有的数据拷贝完成之后再返回。

（2）先标记，不拷数据，有新数据时再处理。（a）直接写入新的对象，这样就不需要拷贝，就是抽定向写对象（ROW）。（b）拷贝原有数据到新的地方，原有位置写新数据，写不需要重定向。

从快照速度上来说，（2）显然更快，但是写入数据时，要么需要重定向，要么需要复制数据。

## 具体用法

#### 创建

先开启该特性 `ceph mds set allow_new_snaps true --yes-i-really-mean-it`

#### 恢复

ceph 没有提供原生的恢复接口

每个目录下都有一个.snap目录

## 实现方式

* 快照域作为inode的一部分进行编码。
* 打过快照的元数据存储在一个叫做 old_inodes这个map中，一个版本的快照信息存放在old_inode_t这个结构中。
* 快照的元数据在底层RADOS自己处理。

#### 文件快照实现流程

流程都是同一个，只是有一个inode号 +　快照版本号。
