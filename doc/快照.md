https://docs.ceph.com/docs/master/dev/cephfs-snapshots/

## 有备份为什么需要快照

备份期间，常常是不允许进行业务的，随着数据越来越大，这个需要暂暂停的时间会越来越长，所以希望这个时间窗口缩小，越小越好。
所以才有快照，持续数据保护等技术出现。

## 优势

在数秒内完成恢复

## 分类

全量快照
增量快照

## 增量快照基本原理

新数据N，原有数据P，打快照时有两种选择：（1）马上把原有数据拷贝出去，这样原有对象就可以写新的数据。但是这样的话，快照操作耗时很多，因为需要原有的数据拷贝完成之后再返回。（2）先标记，不拷数据，有新数据时再处理。（2）显然更快，但是写入数据时，要么需要重定向，要么需要复制数据。

如果要修改时处理POW，那么又分两种，（a）拷贝原有数据到新的地方，原有位置写新数据，写入不需要重定向到其他位置（COW）。（b）直接写入新的位置，这样就不需要拷贝，就是重定向到新的对象，这时候因为有重定向，所以数据的数据的元数据有更改（ROW）。

源数据和镜像数据都有一个指针表用来指向一个文件的不同部分。

## 具体用法

#### 创建

先开启该特性 `ceph mds set allow_new_snaps true --yes-i-really-mean-it`

#### 恢复

ceph 没有提供原生的恢复接口

每个目录下都有一个.snap目录

## 实现方式

* 快照域作为inode的一部分进行编码。
* 打过快照的元数据存储在一个叫做 old_inodes这个map中，一个版本的快照信息存放在old_inode_t这个结构中。
* 快照的元数据在底层RADOS自己处理。

#### 文件快照实现流程

流程都是同一个，只是有一个inode号 +　快照版本号。
